<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>index</title>
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/static/jquery.datetimepicker.min.css"/>
    <style>
        .td_active{
            background-color:purple;
        }

        #my_div{
            top:215px!important;
        }
    </style>
</head>
<body>
<div class="page-header">
    <h1 class="text-center">欢迎来到会议室预定系统<small class="text-info">{{request.user.username}}</small></h1>
</div>

<div class="text-center">
    <span>当前用户：</span>
    <span>其他用户：</span>
</div>
<br>
<br>
<p class="text-center">
    <span><a href="/home/">返回首页</a> </span>
    <span><a href="/logout/">注册</a> </span>
</p>
<div class="calender pull-right">
    <div class="input-group" style="width: 230px;">
        <span class="text-warning">注意：当前日期高亮显示</span>
        <input type="text" autocomplete="off" class="form-control" id="datetimepicker11" placeholder="请选择日期"/>
        <span class="input-group-addon">
            <span class="glyphicon glyphicon-calendar">
            </span>
        </span>
    </div>
</div>
<br>
<br>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>会议室（可容纳人数）/时间</th>
            {% for row in time_choice %}
            <th>{{ row.1 }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {{ htmls|safe }}
    </tbody>
</table>
<div>{% csrf_token %}</div>
<div class="col-lg-offset-6">
    <button class="btn btn-info book_btn">预定</button>
</div>

<script src="/static/js/jquery-3.6.0.min.js"></script>
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/jquery.datetimepicker.full.min.js"></script>
<script>
    Date.prototype.myMet=function(fmt){
        var o={
            "M+":this.getMonth()+1,
            "d+":this.getDate(),
            "h+":this.getHours(),
            "m+":this.getMinutes(),
            "s+":this.getSeconds(),
            "q+":Math.floor((this.getMonth()+3)/3),
            "S":this.getMilliseconds()
        };
        if(/(y+)/.test(fmt)) fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    };
    TODAY_DATE=new Date().myMet("yyyy-MM-dd");
    var POST_DATA={
        "ADD":{},
        "DEL":{},
    };
    function TdClick(){
        //td绑定事件,单击一个单元格触发的事件
        $(".item").click(function(){
            var room_id=$(this).attr("room_id");
            var time_id=$(this).attr("time_id");
            //取消预定
            //TODO 单拿出来放一个取消按钮
            if($(this).hasClass("info")){
                //如果点击的是info类，则删除info类并清空
                //$(this).removeClass("info").empty();
                if(POST_DATA.DEL[room_id]){
                    // 在数据中已经存有会议室信息，将新单元格time_id添加进数组
                    POST_DATA.DEL[room_id].push(time_id);
                }
                else{
                    // 在数据中没有存过对应会议室记录，直接将time_id对其赋值创建一个字典
                    POST_DATA.DEL[room_id]=[time_id,];
                }
            }
            //取消临时预定
            else if($(this).hasClass("td_active")){
                $(this).removeClass("td_active");
                //去掉被选中的标签
                var index=$.inArray(time_id,POST_DATA.ADD[room_id]);
                //在POST数据中删除
                POST_DATA.ADD[room_id].splice(index,1);
            }
            //增加新预定
            else{
                $(this).addClass("td_active");
                if(POST_DATA.ADD[room_id]){
                    POST_DATA.ADD[room_id].push(time_id);
                }
                else{
                    POST_DATA.ADD[room_id]=[time_id,];
                }
            }
        });
    };
    TdClick();

    //日期
    if(location.search.slice(11)){
        CHOOSE_DATE=location.search.slice(11)
    }
    else{
        CHOOSE_DATE=new Date().myMet('yyyy-MM-dd');
    }

    //ajax与后端通信
    $(".book_btn").click(function(){
        console.log("click");
        $.ajax({
            url:"/roomorder/book/",
            type:"post",
            data:{
                choose_date:CHOOSE_DATE,
                csrfmiddlewaretoken:$("[name='csrfmiddlewaretoken']").val(),
                post_data:JSON.stringify(POST_DATA),
            },
            dataType:"json",
            success:function(data){
                if(data.status==1){
                    alert("预定成功");
                    location.href="";
                }else if(data.status==2){
                    alert("未修改信息");
                    location.href="";
                }else{
                    alert("该时间已被预定");
                    location.href="";
                }
            },
        });
    });

    //日历插件
    function book_query(e){
        CHOOSE_DATE=e.date.myMet("yyyy-MM-dd");
        console.log(e);
        location.href="/roomorder/index/?book_date="+CHOOSE_DATE;
    }
    //判断输入日期格式是否正确
    function isDate(data){
        var filter  = /((^((1[8-9]\d{2})|([2-9]\d{3}))([-\/\._])(10|12|0?[13578])([-\/\._])(3[01]|[12][0-9]|0?[1-9])$)|(^((1[8-9]\d{2})|([2-9]\d{3}))([-\/\._])(11|0?[469])([-\/\._])(30|[12][0-9]|0?[1-9])$)|(^((1[8-9]\d{2})|([2-9]\d{3}))([-\/\._])(0?2)([-\/\._])(2[0-8]|1[0-9]|0?[1-9])$)|(^([2468][048]00)([-\/\._])(0?2)([-\/\._])(29)$)|(^([3579][26]00)([-\/\._])(0?2)([-\/\._])(29)$)|(^([1][89][0][48])([-\/\._])(0?2)([-\/\._])(29)$)|(^([2-9][0-9][0][48])([-\/\._])(0?2)([-\/\._])(29)$)|(^([1][89][2468][048])([-\/\._])(0?2)([-\/\._])(29)$)|(^([2-9][0-9][2468][048])([-\/\._])(0?2)([-\/\._])(29)$)|(^([1][89][13579][26])([-\/\._])(0?2)([-\/\._])(29)$)|(^([2-9][0-9][13579][26])([-\/\._])(0?2)([-\/\._])(29)$))/;
        if(filter.test(data)){
            return true;
        }else{
            return false;
        }
    }
    console.log(isDate(TODAY_DATE));
    //监听日期改变
    $("#datetimepicker11").change(function(){
        var test=$(this).val();
        if(isDate(test)){
            if(test<TODAY_DATE){
                console.log(test);
                //alert("只能选择未来日期！");
                CHOOSE_DATE=test;
                location.href="/roomorder/index/?book_date="+CHOOSE_DATE;
            }
            else{
                CHOOSE_DATE=test;
                location.href="/roomorder/index/?book_date="+CHOOSE_DATE;
            }
        }else{
            alert("日期格式错误！");
            location.href="";
        }
    });
    //日历插件初始化及配置
    $('#datetimepicker11').datetimepicker({
        minView:2,
        startView:2,
        language:"zh-CN",
        sideByside:true,
        //timepicker:false,
        format:'Y-m-d',
        startDate:TODAY_DATE,
        todayBtn:true,
        todayHighlight:1,
        enterLikeTab:false,
        bootcssVer:3,
        autoclose:true,
    }).on('change',book_query).val(CHOOSE_DATE).css('font-weight','bold');
    $(".datetimepicker.datetimepicker-dropdown-bottom-right.dropdown-menu").attr("id","my_div");
</script>
</body>
</html>